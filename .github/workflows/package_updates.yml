name: Package Updates

on:
  schedule:
    - cron: '0 0 * * 0' # Runs every Sunday at midnight
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Upgrade pip
      run: pip install --upgrade pip

    - name: Install pip-review
      run: pip install pip-review

    - name: Check for package updates
      id: check_updates
      run: |
        updates=$(pip-review --local | grep -E "datasets|transformers|fiftyone")
        if [ -n "$updates" ]; then
          echo "Updates available for selected packages:"
          echo "$updates"
          echo "::set-output name=updates::true"
        else
          echo "No updates available for selected packages."
          echo "::set-output name=updates::false"

    - name: Create pull request if updates are found
      if: steps.check_updates.outputs.updates == 'true'
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git checkout -b update-packages
        pip-review --auto
        git add requirements.txt
        git commit -m "Update selected packages in requirements.txt"
        git push --set-upstream origin update-packages
        gh pr create --title "Update selected packages in requirements.txt" --body "This PR updates the following packages: transformers, fiftyone" --base main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}